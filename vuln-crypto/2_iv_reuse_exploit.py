#!/usr/bin/env python3
"""
IV μ¬μ‚¬μ© μ·¨μ•½μ  Exploit
κ³µκ²© λ°©λ²•: CBC λ¨λ“μ—μ„ κ°™μ€ IVλ¥Ό μ‚¬μ©ν•λ©΄ ν‰λ¬Έ κ°„μ XOR κ΄€κ³„λ¥Ό μ¶”μ¶ν•  μ μμ

=============================================================================
π“ λ°°κ²½ μ§€μ‹: IV(Initialization Vector)κ°€ λ­”κ°€μ”?
=============================================================================

IVλ” μ•”νΈν™”ν•  λ• μ‚¬μ©ν•λ” "μ΄κΈ°κ°’"μ…λ‹λ‹¤.

μ™ ν•„μ”ν• κΉμ”?
- κ°™μ€ ν‰λ¬Έμ„ κ°™μ€ ν‚¤λ΅ μ•”νΈν™”ν•λ©΄ ν•­μƒ κ°™μ€ μ•”νΈλ¬Έμ΄ λ‚μµλ‹λ‹¤
- μ΄λ¬λ©΄ "μ΄ μ‚¬λμ΄ κ°™μ€ λ©”μ‹μ§€λ¥Ό λ³΄λƒκµ¬λ‚!" ν•κ³  μ• μ μμ–΄μ”
- IVλ¥Ό λ§¤λ² λλ¤ν•κ² λ°”κΎΈλ©΄, κ°™μ€ ν‰λ¬Έλ„ λ§¤λ² λ‹¤λ¥Έ μ•”νΈλ¬Έμ΄ λ©λ‹λ‹¤!

λΉ„μ :
- λΉ„λ°€λ²νΈλ¥Ό μΆ…μ΄μ— μ μ–΄μ„ λ΄‰ν¬μ— λ„£λ”λ‹¤κ³  μƒκ°ν•΄λ³΄μ„Έμ”
- κ°™μ€ λ΄‰ν¬λ¥Ό λ§¤λ² μ“°λ©΄? β†’ λ΄‰ν¬λ§ λ΄λ„ "μ•„, κ°™μ€ λ‚΄μ©μ΄κµ¬λ‚" μ• μ μμ
- λ§¤λ² λ‹¤λ¥Έ μƒ‰ λ΄‰ν¬λ¥Ό μ“°λ©΄? β†’ κ²‰μΌλ΅λ” μ „ν€ κµ¬λ¶„ λ¶κ°€!

IV μ¬μ‚¬μ©μ΄ μ™ μ„ν—ν•κ°€μ”?
- IVκ°€ κ°™μΌλ©΄ μ•”νΈλ¬ΈλΌλ¦¬ XORν•΄μ„ ν‰λ¬Έ μ •λ³΄λ¥Ό μ¶”μ¶ν•  μ μμµλ‹λ‹¤!
- μ΄κ±΄ λ§μΉ "λ‘ λΉ„λ°€ λ©”μ‹μ§€μ μ°¨μ΄μ "μ„ μ•μ•„λ‚΄λ” κ²ƒκ³Ό κ°™μ•„μ”

=============================================================================
"""

import base64
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad

SECRET_KEY = b'SIXTEEN_BYTE_KEY'
FIXED_IV = b'FIXED_IV_16BYTES'  # β† μ΄κ² λ¬Έμ ! ν•­μƒ κ°™μ€ IVλ¥Ό μ‚¬μ©

def encrypt_with_reused_iv(plaintext: str) -> str:
    """μ·¨μ•½ν• μ•”νΈν™” ν•¨μ - ν•­μƒ κ°™μ€ IV μ‚¬μ©"""
    cipher = AES.new(SECRET_KEY, AES.MODE_CBC, FIXED_IV)
    padded = pad(plaintext.encode(), AES.block_size)
    ciphertext = cipher.encrypt(padded)
    return base64.b64encode(ciphertext).decode()

def xor_bytes(a: bytes, b: bytes) -> bytes:
    """λ‘ λ°”μ΄νΈμ—΄μ„ XOR"""
    return bytes(x ^ y for x, y in zip(a, b))

def detect_iv_reuse():
    """
    IV μ¬μ‚¬μ© νƒμ§€

    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    β”‚ 1λ‹¨κ³„: νƒμ§€ - μ„λ²„κ°€ IVλ¥Ό μ¬μ‚¬μ©ν•λ”μ§€ ν™•μΈ                      β”‚
    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    """
    print("=" * 70)
    print("1λ‹¨κ³„: IV μ¬μ‚¬μ© νƒμ§€")
    print("=" * 70 + "\n")

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # STEP 1: νƒμ§€ μ›λ¦¬ μ΄ν•΄
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    print("[STEP 1] νƒμ§€ μ›λ¦¬")
    print("    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”")
    print("    β”‚ μ •μƒμ μΈ μ•”νΈν™”:                                       β”‚")
    print("    β”‚   κ°™μ€ ν‰λ¬Έ β†’ λ§¤λ² λ‹¤λ¥Έ μ•”νΈλ¬Έ (IVκ°€ λ§¤λ² λ‹¤λ¥΄λ‹κΉ)    β”‚")
    print("    β”‚                                                        β”‚")
    print("    β”‚ μ·¨μ•½ν• μ•”νΈν™”:                                         β”‚")
    print("    β”‚   κ°™μ€ ν‰λ¬Έ β†’ ν•­μƒ κ°™μ€ μ•”νΈλ¬Έ (IVκ°€ κ³ μ •μ΄λ‹κΉ!)      β”‚")
    print("    β”‚                                                        β”‚")
    print("    β”‚ νƒμ§€ λ°©λ²•:                                             β”‚")
    print("    β”‚   κ°™μ€ λ©”μ‹μ§€λ¥Ό λ‘ λ² λ³΄λ‚΄μ„ μ•”νΈλ¬Έμ΄ κ°™μ€μ§€ ν™•μΈ!     β”‚")
    print("    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”\n")

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # STEP 2: ν…μ¤νΈ μν–‰
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    print("[STEP 2] ν…μ¤νΈ μν–‰")
    print("    μλ„: κ°™μ€ ν‰λ¬Έμ„ λ‘ λ² μ•”νΈν™” μ”μ²­")
    print("    μ΄μ : IVκ°€ κ³ μ •μ΄λ©΄ λ‘ μ•”νΈλ¬Έμ΄ λ™μΌν•  κ²ƒ\n")

    plaintext = "This is a test message for IV reuse detection!!"
    print(f"    ν…μ¤νΈ ν‰λ¬Έ: '{plaintext}'\n")

    # μ²« λ²μ§Έ μ•”νΈν™”
    print("    [μ”μ²­ 1] μ²« λ²μ§Έ μ•”νΈν™” μ”μ²­...")
    enc1 = encrypt_with_reused_iv(plaintext)
    print(f"    μ‘λ‹µ μ•”νΈλ¬Έ: {enc1}\n")

    # λ‘ λ²μ§Έ μ•”νΈν™” (κ°™μ€ ν‰λ¬Έ)
    print("    [μ”μ²­ 2] λ‘ λ²μ§Έ μ•”νΈν™” μ”μ²­ (κ°™μ€ ν‰λ¬Έ)...")
    enc2 = encrypt_with_reused_iv(plaintext)
    print(f"    μ‘λ‹µ μ•”νΈλ¬Έ: {enc2}\n")

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # STEP 3: κ²°κ³Ό λ¶„μ„
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    print("[STEP 3] κ²°κ³Ό λ¶„μ„")

    if enc1 == enc2:
        print("    μ•”νΈλ¬Έ1 == μ•”νΈλ¬Έ2  β†’  TRUE!\n")

        print("    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”")
        print("    β”‚ μ΄κ²ƒμ΄ μλ―Έν•λ” κ²ƒ:                                      β”‚")
        print("    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤")
        print("    β”‚ 1. μ„λ²„κ°€ IVλ¥Ό μ¬μ‚¬μ©ν•κ³  μμ!                          β”‚")
        print("    β”‚ 2. λ§¤λ² κ°™μ€ IVλ΅ μ•”νΈν™” β†’ κ°™μ€ κ²°κ³Ό                     β”‚")
        print("    β”‚ 3. μ΄κ±΄ μ‹¬κ°ν• λ³΄μ• μ·¨μ•½μ !                              β”‚")
        print("    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”")

        print("\n    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”")
        print("    β”‚ μ΄ μ·¨μ•½μ μΌλ΅ κ°€λ¥ν• κ³µκ²©:                               β”‚")
        print("    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤")
        print("    β”‚ 1. μ•λ ¤μ§„ ν‰λ¬Έ κ³µκ²© (Known Plaintext Attack)             β”‚")
        print("    β”‚    β†’ λ‚΄ λ©”μ‹μ§€λ¥Ό μ΄μ©ν•΄ λ‚¨μ λ©”μ‹μ§€ ν•΄λ…                 β”‚")
        print("    β”‚                                                         β”‚")
        print("    β”‚ 2. λΉ„νΈ ν”λ¦¬ν•‘ κ³µκ²© (Bit Flipping Attack)                β”‚")
        print("    β”‚    β†’ μ•”νΈλ¬Έμ„ μ΅°μ‘ν•΄ λ³µνΈν™” κ²°κ³Ό λ³€μ΅°                    β”‚")
        print("    β”‚                                                         β”‚")
        print("    β”‚ 3. μ¬μƒ κ³µκ²© (Replay Attack)                             β”‚")
        print("    β”‚    β†’ κ³Όκ±° μ”μ²­μ„ λ‹¤μ‹ λ³΄λ‚΄ μ¤‘λ³µ μ‹¤ν–‰                     β”‚")
        print("    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”\n")
        return True
    else:
        print("    μ•”νΈλ¬Έ1 != μ•”νΈλ¬Έ2 β†’ μ•μ „ (IVκ°€ λ§¤λ² λ‹¤λ¦„)")
    return False

def known_plaintext_attack():
    """
    μ•λ ¤μ§„ ν‰λ¬Έ κ³µκ²© (Known Plaintext Attack)

    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    β”‚ 2λ‹¨κ³„: μ•λ ¤μ§„ ν‰λ¬Έ κ³µκ²© - λ‚¨μ λ©”μ‹μ§€ λ‚΄μ© μ•μ•„λ‚΄κΈ°              β”‚
    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    """
    print("=" * 70)
    print("2λ‹¨κ³„: μ•λ ¤μ§„ ν‰λ¬Έ κ³µκ²© (Known Plaintext Attack)")
    print("=" * 70 + "\n")

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # κ³µκ²© μ‹λ‚λ¦¬μ¤ μ„¤λ…
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    print("[κ³µκ²© μ‹λ‚λ¦¬μ¤]")
    print("    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”")
    print("    β”‚ μƒν™©: μ€ν–‰ μ‹μ¤ν…μ΄ IVλ¥Ό μ¬μ‚¬μ©ν•κ³  μμ               β”‚")
    print("    β”‚                                                        β”‚")
    print("    β”‚ κ³µκ²©μκ°€ κ°€μ§„ κ²ƒ:                                      β”‚")
    print("    β”‚   1. μμ‹ μ΄ λ³΄λ‚Έ λ©”μ‹μ§€μ ν‰λ¬Έκ³Ό μ•”νΈλ¬Έ                β”‚")
    print("    β”‚   2. λ‹¤λ¥Έ μ‚¬λμ΄ λ³΄λ‚Έ μ•”νΈλ¬Έ (λ„¤νΈμ›ν¬μ—μ„ κ°€λ΅μ±”)     β”‚")
    print("    β”‚                                                        β”‚")
    print("    β”‚ κ³µκ²©μμ λ©ν‘:                                         β”‚")
    print("    β”‚   β†’ λ‹¤λ¥Έ μ‚¬λμ λ©”μ‹μ§€ λ‚΄μ©μ„ μ•μ•„λ‚΄κΈ°!                β”‚")
    print("    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”\n")

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # STEP 1: κ³µκ²© μ›λ¦¬ μ„¤λ…
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    print("[STEP 1] κ³µκ²© μ›λ¦¬ - μ™ μ΄κ² κ°€λ¥ν• κΉ?")
    print("-" * 60)

    print("""
    CBC λ¨λ“μ—μ„ μ²« λ²μ§Έ λΈ”λ΅μ€ μ΄λ ‡κ² μ•”νΈν™”λ©λ‹λ‹¤:

        μ•”νΈλ¬Έ = Encrypt(ν‰λ¬Έ XOR IV)

    λ‘ κ°μ λ©”μ‹μ§€κ°€ κ°™μ€ IVλ΅ μ•”νΈν™”λλ©΄:
        μ•”νΈλ¬Έ_A = Encrypt(ν‰λ¬Έ_A XOR IV)
        μ•”νΈλ¬Έ_B = Encrypt(ν‰λ¬Έ_B XOR IV)

    XORμ νΉμ„±μ„ μ΄μ©ν•λ©΄:
        ν‰λ¬Έ_A XOR ν‰λ¬Έ_B = (ν‰λ¬Έ_A XOR IV) XOR (ν‰λ¬Έ_B XOR IV)
                         = ν‰λ¬Έ_A XOR ν‰λ¬Έ_B  β† IVκ°€ μ„λ΅ μƒμ‡„λ¨!

    κ²°λ΅ :
        β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
        β”‚ ν‰λ¬Έ_Aλ¥Ό μ•κ³  μλ‹¤λ©΄                                 β”‚
        β”‚ ν‰λ¬Έ_B = ν‰λ¬Έ_A XOR (ν‰λ¬Έ_A XOR ν‰λ¬Έ_B)               β”‚
        β”‚ λ¥Ό κ³„μ‚°ν•΄μ„ ν‰λ¬Έ_Bλ¥Ό λ³µκµ¬ν•  μ μλ‹¤!                 β”‚
        β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    """)

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # STEP 2: μ‹¤μ  κ³µκ²© μν–‰
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    print("[STEP 2] μ‹¤μ  κ³µκ²© μν–‰")
    print("-" * 60)

    # κ³µκ²©μκ°€ μ•„λ” λ©”μ‹μ§€ (μμ‹ μ΄ λ³΄λ‚Έ κ²ƒ)
    known_msg = "Transfer 1000 won to Alice"
    # νƒ€μΈμ λ©”μ‹μ§€ (κ³µκ²©μκ°€ λ¨λ¥΄λ” κ²ƒ)
    unknown_msg = "Transfer 9999 won to Admin"

    print(f"\n    2-1. κ³µκ²©μμ μ •λ³΄")
    print(f"         μμ‹ μ ν‰λ¬Έ:   '{known_msg}'")

    enc_known = encrypt_with_reused_iv(known_msg)
    print(f"         μμ‹ μ μ•”νΈλ¬Έ: {enc_known}")

    print(f"\n    2-2. κ°€λ΅μ± μ •λ³΄ (λ„¤νΈμ›ν¬ μ¤λ‹ν•‘)")
    enc_unknown = encrypt_with_reused_iv(unknown_msg)
    print(f"         νƒ€μΈμ μ•”νΈλ¬Έ: {enc_unknown}")
    print(f"         νƒ€μΈμ ν‰λ¬Έ:   ??? (μ΄κ±Έ μ•μ•„λ‚΄κ³  μ‹¶μ!)")

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # STEP 3: XOR μ—°μ‚°μΌλ΅ λ³µκµ¬
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    print(f"\n    2-3. XOR μ—°μ‚°μΌλ΅ ν‰λ¬Έ λ³µκµ¬")

    # λ‘ ν‰λ¬Έμ μ²« 16λ°”μ΄νΈ (μ²« λΈ”λ΅)
    known_bytes = known_msg.encode()[:16]
    unknown_bytes = unknown_msg.encode()[:16]

    print(f"         μ•λ ¤μ§„ ν‰λ¬Έ (μ²« λΈ”λ΅): '{known_msg[:16]}'")
    print(f"         μ•λ ¤μ§„ ν‰λ¬Έ (hex):     {known_bytes.hex()}")

    # ν‰λ¬Έλ“¤μ XOR κ³„μ‚° (κ°™μ€ IVλ΅ μ•”νΈν™” μ‹ μ΄ κ΄€κ³„κ°€ μ μ§€λ¨)
    plaintext_xor = xor_bytes(known_bytes, unknown_bytes)
    print(f"\n         ν‰λ¬Έ XOR κ²°κ³Ό: {plaintext_xor.hex()}")

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # STEP 4: μµμΆ… λ³µκµ¬
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    print("\n[STEP 3] μµμΆ… λ³µκµ¬")
    print("-" * 60)

    print("""
    κ³µμ‹: λ¨λ¥΄λ”ν‰λ¬Έ = μ•„λ”ν‰λ¬Έ XOR (μ•„λ”ν‰λ¬Έ XOR λ¨λ¥΄λ”ν‰λ¬Έ)

    μ½”λ“λ΅ ν‘ν„:
        recovered = known_bytes XOR plaintext_xor
    """)

    recovered = xor_bytes(known_bytes, plaintext_xor)
    print(f"    λ³µκµ¬λ ν‰λ¬Έ: '{recovered.decode()}'")
    print(f"    μ‹¤μ  ν‰λ¬Έ:   '{unknown_msg[:16]}'")

    if recovered.decode() == unknown_msg[:16]:
        print(f"\n    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”")
        print(f"    β”‚ κ³µκ²© μ„±κ³µ!                                             β”‚")
        print(f"    β”‚                                                        β”‚")
        print(f"    β”‚ κ²°κ³Ό:                                                  β”‚")
        print(f"    β”‚   νƒ€μΈμ κ±°λ λ‚΄μ—­μ„ λ³µκµ¬ν–μµλ‹λ‹¤!                     β”‚")
        print(f"    β”‚   '{recovered.decode()}'")
        print(f"    β”‚                                                        β”‚")
        print(f"    β”‚ μ™ μ΄κ² κ°€λ¥ν–λ‚?                                      β”‚")
        print(f"    β”‚   β†’ IVκ°€ κ°™μ•„μ„ μ•”νΈλ¬Έ κ°„ XOR = ν‰λ¬Έ κ°„ XOR            β”‚")
        print(f"    β”‚   β†’ ν•λ‚μ ν‰λ¬Έμ„ μ•λ©΄ λ‹¤λ¥Έ ν‰λ¬Έμ„ λ³µκµ¬ κ°€λ¥           β”‚")
        print(f"    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”")

def bit_flipping_attack():
    """
    λΉ„νΈ ν”λ¦¬ν•‘ κ³µκ²© (Bit Flipping Attack)

    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    β”‚ 3λ‹¨κ³„: λΉ„νΈ ν”λ¦¬ν•‘ - μ•”νΈλ¬Έμ„ κ±΄λ“λ¦¬μ§€ μ•κ³  λ³µνΈν™” κ²°κ³Ό μ΅°μ‘     β”‚
    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    """
    print("\n" + "=" * 70)
    print("3λ‹¨κ³„: λΉ„νΈ ν”λ¦¬ν•‘ κ³µκ²© (Bit Flipping Attack)")
    print("=" * 70 + "\n")

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # κ³µκ²© μ‹λ‚λ¦¬μ¤ μ„¤λ…
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    print("[κ³µκ²© μ‹λ‚λ¦¬μ¤]")
    print("    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”")
    print("    β”‚ μƒν™©: μ›Ήμ‚¬μ΄νΈκ°€ μΏ ν‚¤μ— μ‚¬μ©μ μ •λ³΄λ¥Ό μ•”νΈν™”ν•΄μ„ μ €μ¥  β”‚")
    print("    β”‚       μΏ ν‚¤ ν•μ‹: 'user_id:attacker' (μ•”νΈν™”λ¨)         β”‚")
    print("    β”‚                                                        β”‚")
    print("    β”‚ κ³µκ²©μμ λ©ν‘:                                         β”‚")
    print("    β”‚   'attacker' β†’ 'adminXXX' λ΅ λ³€κ²½ν•΄μ„ κ΄€λ¦¬μ λκΈ°!    β”‚")
    print("    β”‚                                                        β”‚")
    print("    β”‚ νΉμ΄μ :                                                β”‚")
    print("    β”‚   μ•”νΈλ¬Έ μμ²΄λ” κ±΄λ“λ¦¬μ§€ μ•κ³ , IVλ§ μ΅°μ‘!              β”‚")
    print("    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”\n")

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # STEP 1: κ³µκ²© μ›λ¦¬ μ„¤λ…
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    print("[STEP 1] κ³µκ²© μ›λ¦¬")
    print("-" * 60)

    print("""
    CBC λ³µνΈν™” κ³Όμ • (μ²« λΈ”λ΅):

        ν‰λ¬Έ = Decrypt(μ•”νΈλ¬Έ) XOR IV

    λ”°λΌμ„:
        β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
        β”‚ IVλ¥Ό λ³€μ΅°ν•λ©΄ λ³µνΈν™” κ²°κ³Ό(ν‰λ¬Έ)κ°€ λ³€μ΅°λλ‹¤!           β”‚
        β”‚                                                        β”‚
        β”‚ μƒλ΅μ΄ IV = μ›λIV XOR μ›λν‰λ¬Έ XOR λ©ν‘ν‰λ¬Έ           β”‚
        β”‚                                                        β”‚
        β”‚ κ·Έλ¬λ©΄:                                                β”‚
        β”‚   μƒν‰λ¬Έ = Decrypt(μ•”νΈλ¬Έ) XOR μƒIV                    β”‚
        β”‚         = Decrypt(μ•”νΈλ¬Έ) XOR μ›λIV XOR μ›λν‰λ¬Έ XOR λ©ν‘ν‰λ¬Έ β”‚
        β”‚         = μ›λν‰λ¬Έ XOR μ›λν‰λ¬Έ XOR λ©ν‘ν‰λ¬Έ            β”‚
        β”‚         = λ©ν‘ν‰λ¬Έ  β† μ°λ¦¬κ°€ μ›ν•λ” κ°’!                 β”‚
        β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    """)

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # STEP 2: κ³µκ²© μ¤€λΉ„
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    print("[STEP 2] κ³µκ²© μ¤€λΉ„")
    print("-" * 60)

    original = "user_id:attacker"  # 16λ°”μ΄νΈ
    target = "user_id:adminXXX"    # 16λ°”μ΄νΈ (κ°™μ€ κΈΈμ΄)

    print(f"\n    μ›λ³Έ ν‰λ¬Έ: '{original}'")
    print(f"    λ©ν‘ ν‰λ¬Έ: '{target}'")

    encrypted = encrypt_with_reused_iv(original)
    print(f"    μ•”νΈλ¬Έ: {encrypted}")
    print(f"    μ•λ ¤μ§„ IV: {FIXED_IV.hex()}")

    print(f"\n    λ°”μ΄νΈλ³„ λΉ„κµ:")
    print(f"    μ›λ³Έ: ", end="")
    for c in original:
        print(f"'{c}' ", end="")
    print()
    print(f"    λ©ν‘: ", end="")
    for c in target:
        print(f"'{c}' ", end="")
    print()
    print(f"    μ°¨μ΄: ", end="")
    for o, t in zip(original, target):
        if o == t:
            print("  = ", end="")
        else:
            print(f"'{o}'β†’'{t}'", end="")
    print("\n")

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # STEP 3: IV λ³€μ΅° κ³„μ‚°
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    print("[STEP 3] IV λ³€μ΅° κ³„μ‚°")
    print("-" * 60)

    original_bytes = original.encode()
    target_bytes = target.encode()

    print(f"\n    κ³µμ‹: IV_new = IV XOR μ›λν‰λ¬Έ XOR λ©ν‘ν‰λ¬Έ")
    print(f"\n    κ³„μ‚°:")
    print(f"      IV_original:  {FIXED_IV.hex()}")
    print(f"      μ›λν‰λ¬Έ XOR: {original_bytes.hex()}")
    print(f"      λ©ν‘ν‰λ¬Έ XOR: {target_bytes.hex()}")

    # IV λ³€μ΅° κ³„μ‚°
    iv_modified = xor_bytes(
        xor_bytes(FIXED_IV, original_bytes),
        target_bytes
    )

    print(f"\n      κ²°κ³Ό IV_new:  {iv_modified.hex()}")

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # STEP 4: κ³µκ²© μ‹¤ν–‰ λ° κ²°κ³Ό ν™•μΈ
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    print("\n[STEP 4] κ³µκ²© μ‹¤ν–‰")
    print("-" * 60)

    print("\n    λ³€μ΅°λ IVλ΅ λ³µνΈν™”λ¥Ό μ”μ²­ν•©λ‹λ‹¤...")

    cipher = AES.new(SECRET_KEY, AES.MODE_CBC, iv_modified)
    ciphertext = base64.b64decode(encrypted)
    try:
        from Crypto.Util.Padding import unpad
        plaintext = unpad(cipher.decrypt(ciphertext), AES.block_size)
        result = plaintext.decode()

        print(f"\n    λ³µνΈν™” κ²°κ³Ό: '{result}'")
        print(f"    λ©ν‘ν–λ κ°’: '{target}'")

        if result == target:
            print(f"\n    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”")
            print(f"    β”‚ κ³µκ²© μ„±κ³µ!                                             β”‚")
            print(f"    β”‚                                                        β”‚")
            print(f"    β”‚ κ²°κ³Ό:                                                  β”‚")
            print(f"    β”‚   'attacker' β†’ 'adminXXX' λ³€μ΅° μ„±κ³µ!                  β”‚")
            print(f"    β”‚   μΌλ° μ‚¬μ©μκ°€ κ΄€λ¦¬μ κ¶ν• νλ“!                      β”‚")
            print(f"    β”‚                                                        β”‚")
            print(f"    β”‚ μ™ μ΄κ² κ°€λ¥ν–λ‚?                                      β”‚")
            print(f"    β”‚   β†’ CBC λ¨λ“μ—μ„ IVλ” μ²« λΈ”λ΅ λ³µνΈν™”μ— XORλ¨          β”‚")
            print(f"    β”‚   β†’ IVλ¥Ό μ΅°μ‘ν•λ©΄ λ³µνΈν™” κ²°κ³Όλ¥Ό μ›ν•λ”λ€λ΅ λ³€μ΅°        β”‚")
            print(f"    β”‚   β†’ μ„λ²„λ” μ•”νΈλ¬Έμ΄ μ •μƒμ΄λΌ μ΅°μ‘μ„ κ°μ§€ λ»ν•¨          β”‚")
            print(f"    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”")
    except Exception as e:
        print(f"    μ¤λ¥: {e}")

def replay_attack():
    """
    μ¬μƒ κ³µκ²© (Replay Attack)

    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    β”‚ 4λ‹¨κ³„: μ¬μƒ κ³µκ²© - κ³Όκ±° μ”μ²­μ„ λ‹¤μ‹ λ³΄λ‚΄ μ¤‘λ³µ μ‹¤ν–‰ μ λ„          β”‚
    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    """
    print("\n" + "=" * 70)
    print("4λ‹¨κ³„: μ¬μƒ κ³µκ²© (Replay Attack)")
    print("=" * 70 + "\n")

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # κ³µκ²© μ‹λ‚λ¦¬μ¤ μ„¤λ…
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    print("[κ³µκ²© μ‹λ‚λ¦¬μ¤]")
    print("    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”")
    print("    β”‚ μƒν™©: Aliceκ°€ Bobμ—κ² 1000μ› μ†΅κΈ                      β”‚")
    print("    β”‚       μ€ν–‰ μ„λ²„κ°€ μ•”νΈν™”λ μ”μ²­μ„ μ²λ¦¬                 β”‚")
    print("    β”‚                                                        β”‚")
    print("    β”‚ κ³µκ²©μμ λ¥λ ¥:                                         β”‚")
    print("    β”‚   λ„¤νΈμ›ν¬μ—μ„ μ•”νΈν™”λ μ”μ²­μ„ κ°€λ΅μ± μ μμ          β”‚")
    print("    β”‚   (λ‚΄μ©μ„ λ°λΌλ„ λ¨ - κ·Έλƒ¥ λ³µμ‚¬λ§!)                    β”‚")
    print("    β”‚                                                        β”‚")
    print("    β”‚ κ³µκ²©μμ λ©ν‘:                                         β”‚")
    print("    β”‚   κ°™μ€ μ”μ²­μ„ μ—¬λ¬ λ² λ³΄λ‚΄μ„ Alice κ³„μΆ ν„ΈκΈ°!          β”‚")
    print("    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”\n")

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # STEP 1: κ³µκ²© μ›λ¦¬ μ„¤λ…
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    print("[STEP 1] κ³µκ²© μ›λ¦¬")
    print("-" * 60)

    print("""
    IV μ¬μ‚¬μ© + νƒ€μ„μ¤νƒ¬ν”„/Nonce μ—†μ = μ¬μƒ κ³µκ²© κ°€λ¥!

    λ¬Έμ μ :
    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    β”‚ 1. IVκ°€ κ³ μ • β†’ κ°™μ€ μ”μ²­ = κ°™μ€ μ•”νΈλ¬Έ                    β”‚
    β”‚ 2. μ„λ²„κ°€ "μ΄λ―Έ μ²λ¦¬λ μ”μ²­μΈμ§€" ν™•μΈν•μ§€ μ•μ            β”‚
    β”‚ 3. κ³µκ²©μκ°€ μ•”νΈλ¬Έμ„ λ³µμ‚¬ν•΄μ„ λ‹¤μ‹ λ³΄λ‚΄λ©΄ μ„λ²„λ” μ²λ¦¬ν•¨!  β”‚
    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    """)

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # STEP 2: κ³µκ²© μ‹λ®¬λ μ΄μ…
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    print("[STEP 2] κ³µκ²© μ‹λ®¬λ μ΄μ…")
    print("-" * 60)

    message = "Transfer 1000 won from Alice to Bob"
    encrypted = encrypt_with_reused_iv(message)

    print(f"\n    2-1. μ •λ‹Ήν• κ±°λ λ°μƒ")
    print(f"         Aliceμ μ”μ²­: '{message}'")
    print(f"         μ•”νΈλ¬Έ: {encrypted[:40]}...")
    print(f"         β†’ μ„λ²„: κ±°λ μ²λ¦¬ μ™„λ£, Alice -1000μ›\n")

    print(f"    2-2. κ³µκ²©μκ°€ μ•”νΈλ¬Έμ„ κ°€λ΅μ±”")
    print(f"         κ°€λ΅μ± μ•”νΈλ¬Έ: {encrypted[:40]}...")
    print(f"         (κ³µκ²©μλ” λ‚΄μ©μ„ λ°λΌλ„ λ¨!)\n")

    print(f"    2-3. κ³µκ²©μκ°€ μ¬μ „μ†΅ κ³µκ²© μ‹¤ν–‰")
    for i in range(3):
        print(f"         [μ¬μ „μ†΅ #{i+1}] κ°™μ€ μ•”νΈλ¬Έ μ „μ†΅")
        print(f"         β†’ μ„λ²„: κ±°λ μ²λ¦¬ μ™„λ£, Alice -{1000*(i+2)}μ› (λ„μ )")

    print(f"\n    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”")
    print(f"    β”‚ κ³µκ²© κ²°κ³Ό:                                             β”‚")
    print(f"    β”‚                                                        β”‚")
    print(f"    β”‚   μ›λ μλ„: 1ν μ†΅κΈ (1,000μ›)                        β”‚")
    print(f"    β”‚   μ‹¤μ  κ²°κ³Ό: 4ν μ†΅κΈ (4,000μ›)                        β”‚")
    print(f"    β”‚                                                        β”‚")
    print(f"    β”‚   Alice κ³„μΆμ—μ„ 4,000μ›μ΄ λΉ μ Έλ‚κ°!                   β”‚")
    print(f"    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”")

    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    # STEP 3: λ°©μ–΄ λ°©λ²•
    # β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
    print("\n[STEP 3] μ™ μ΄κ² κ°€λ¥ν–λ‚? & λ°©μ–΄ λ°©λ²•")
    print("-" * 60)

    print("""
    μ™ μ΄κ² κ°€λ¥ν–λ‚?
    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    β”‚ 1. IVκ°€ κ³ μ • β†’ κ°™μ€ λ©”μ‹μ§€λ” ν•­μƒ κ°™μ€ μ•”νΈλ¬Έ             β”‚
    β”‚ 2. μ„λ²„κ°€ μ”μ²­μ "μ‹ μ„ λ„(freshness)"λ¥Ό κ²€μ¦ν•μ§€ μ•μ      β”‚
    β”‚ 3. κ° μ”μ²­μ— κ³ μ  μ‹λ³„μκ°€ μ—†μ                           β”‚
    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

    λ°©μ–΄ λ°©λ²•:
    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    β”‚ 1. λλ¤ IV μ‚¬μ©                                           β”‚
    β”‚    β†’ κ°™μ€ λ©”μ‹μ§€λ„ λ§¤λ² λ‹¤λ¥Έ μ•”νΈλ¬Έ                       β”‚
    β”‚                                                            β”‚
    β”‚ 2. νƒ€μ„μ¤νƒ¬ν”„ ν¬ν•¨                                        β”‚
    β”‚    β†’ μ¤λλ μ”μ²­μ€ μ„λ²„κ°€ κ±°λ¶€                            β”‚
    β”‚                                                            β”‚
    β”‚ 3. Nonce(μΌνμ© λ²νΈ) μ‚¬μ©                                β”‚
    β”‚    β†’ μ„λ²„κ°€ μ΄λ―Έ μ‚¬μ©λ nonceλ¥Ό κΈ°μ–µν•κ³  κ±°λ¶€             β”‚
    β”‚                                                            β”‚
    β”‚ 4. μΈμ¦λ μ•”νΈν™”(Authenticated Encryption) μ‚¬μ©           β”‚
    β”‚    β†’ GCM, CCM λ“± λ¬΄κ²°μ„± κ²€μ¦ ν¬ν•¨λ λ¨λ“                  β”‚
    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    """)

if __name__ == "__main__":
    print("β•”" + "β•" * 68 + "β•—")
    print("β•‘" + "IV μ¬μ‚¬μ© μ·¨μ•½μ  Exploit λ°λ¨".center(68) + "β•‘")
    print("β•‘" + "(κ³ λ“±ν•™μƒλ„ μ΄ν•΄ν•  μ μλ” μΉμ ν• μ„¤λ…)".center(60) + "        β•‘")
    print("β•" + "β•" * 68 + "β•\n")

    # 1. IV μ¬μ‚¬μ© νƒμ§€
    detect_iv_reuse()

    # 2. μ•λ ¤μ§„ ν‰λ¬Έ κ³µκ²©
    known_plaintext_attack()

    # 3. λΉ„νΈ ν”λ¦¬ν•‘ κ³µκ²©
    bit_flipping_attack()

    # 4. μ¬μƒ κ³µκ²©
    replay_attack()

    print("\n" + "=" * 70)
    print("π’΅ ν•µμ‹¬ μ •λ¦¬")
    print("=" * 70)
    print("""
    IV μ¬μ‚¬μ©μ΄ μ„ν—ν• μ΄μ :
    1. κ°™μ€ ν‰λ¬Έ β†’ κ°™μ€ μ•”νΈλ¬Έμ΄ λμ–΄ ν¨ν„΄ λ…Έμ¶
    2. XOR μ—°μ‚°μΌλ΅ ν‰λ¬Έ μ •λ³΄ μ¶”μ¶ κ°€λ¥
    3. IV λ³€μ΅°λ΅ λ³µνΈν™” κ²°κ³Ό μ΅°μ‘ κ°€λ¥
    4. μ¬μƒ κ³µκ²©μ— μ·¨μ•½

    μ•μ „ν• λ°©λ²•:
    β“ λ§¤λ² λλ¤ν• IV μƒμ„± (os.urandom() λ“±)
    β“ μΈμ¦λ μ•”νΈν™” λ¨λ“ μ‚¬μ© (AES-GCM κ¶μ¥)
    β“ νƒ€μ„μ¤νƒ¬ν”„λ‚ Nonceλ΅ μ”μ²­ μ‹ μ„ λ„ κ²€μ¦
    """)
    print("=" * 70)
